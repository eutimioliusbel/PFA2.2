# PostgreSQL 15 Configuration for PFA Vanguard
# Optimized for 1M+ records with JSONB and materialized views
# Target: Sub-100ms query performance

# ==============================================================================
# CONNECTION SETTINGS
# ==============================================================================

listen_addresses = '*'
max_connections = 100
superuser_reserved_connections = 3

# ==============================================================================
# MEMORY SETTINGS (Adjust based on available RAM)
# ==============================================================================

# Shared Buffers: 25% of RAM (for 8GB RAM = 2GB)
shared_buffers = 2GB

# Work Memory: For sorting/grouping operations (per operation)
work_mem = 128MB  # Increase for complex aggregations

# Maintenance Work Memory: For VACUUM, CREATE INDEX, etc.
maintenance_work_mem = 512MB

# Effective Cache Size: 75% of RAM (PostgreSQL + OS cache)
effective_cache_size = 6GB

# ==============================================================================
# QUERY PLANNER SETTINGS
# ==============================================================================

# Random page cost: Lower for SSDs (default: 4.0)
random_page_cost = 1.1  # SSD optimized

# Effective IO Concurrency: Number of concurrent disk I/O operations
effective_io_concurrency = 200  # SSD optimized

# Parallel Workers
max_parallel_workers_per_gather = 4
max_parallel_workers = 8
max_worker_processes = 8

# JIT Compilation (PostgreSQL 11+)
jit = on

# ==============================================================================
# WRITE-AHEAD LOG (WAL) SETTINGS
# ==============================================================================

# WAL Level: For replication and point-in-time recovery
wal_level = replica

# WAL Buffers: -1 = auto (1/32 of shared_buffers)
wal_buffers = -1

# Checkpoint Settings
checkpoint_timeout = 15min
checkpoint_completion_target = 0.9
max_wal_size = 4GB
min_wal_size = 1GB

# ==============================================================================
# LOGGING SETTINGS (Development)
# ==============================================================================

logging_collector = on
log_destination = 'stderr'
log_directory = '/var/log/postgresql'
log_filename = 'postgresql-%Y-%m-%d.log'
log_rotation_age = 1d
log_rotation_size = 100MB

# Log slow queries (>100ms)
log_min_duration_statement = 100

# Log statements
log_statement = 'none'  # Change to 'all' for debugging
log_duration = off
log_line_prefix = '%m [%p] %u@%d '

# ==============================================================================
# AUTOVACUUM SETTINGS (For 1M+ records)
# ==============================================================================

autovacuum = on
autovacuum_max_workers = 3
autovacuum_naptime = 1min

# Aggressive autovacuum for large tables
autovacuum_vacuum_scale_factor = 0.05  # Vacuum after 5% changes
autovacuum_analyze_scale_factor = 0.02  # Analyze after 2% changes

# ==============================================================================
# STATISTICS SETTINGS
# ==============================================================================

# Track query statistics (requires pg_stat_statements extension)
shared_preload_libraries = 'pg_stat_statements'
pg_stat_statements.max = 10000
pg_stat_statements.track = all

# Statistics Targets: Higher = better query plans
default_statistics_target = 100  # Default: 100, increase for large tables

# ==============================================================================
# LOCALE SETTINGS
# ==============================================================================

lc_messages = 'en_US.utf8'
lc_monetary = 'en_US.utf8'
lc_numeric = 'en_US.utf8'
lc_time = 'en_US.utf8'
default_text_search_config = 'pg_catalog.english'

# ==============================================================================
# CLIENT CONNECTION DEFAULTS
# ==============================================================================

datestyle = 'iso, mdy'
timezone = 'UTC'
client_encoding = 'UTF8'

# ==============================================================================
# EXTENSIONS (Auto-load on database creation)
# ==============================================================================

# Required for PFA Vanguard:
# - uuid-ossp: UUID generation
# - pg_stat_statements: Query performance tracking
# - pg_trgm: Full-text search optimization (if needed)
