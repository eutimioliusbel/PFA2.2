# Phase 8 Task 8.2: Narrative Variance Generator (UC 22) - Complete Prompt Bundle

**Agent Assignment**: `ai-systems-architect`
**Estimated Duration**: 0.5 days
**Status**: Ready for Execution
**Dependencies**: Phase 6 Complete (AI Foundation), Task 8.1 (Voice Analyst)

---

## üéØ Executive Summary

**Mission**: Implement an AI-powered narrative generation system that converts raw budget variance data into executive-ready storytelling. Transform spreadsheet numbers into chapter-based narratives that explain "why" variances occurred, backed by audit log evidence.

**Business Value**:
- **Board Meeting Prep**: Auto-generate variance explanations for board decks (saves 2-4 hours/month)
- **Stakeholder Communication**: Professional, consistent narratives for stakeholder updates
- **Root Cause Transparency**: AI links variance to audit log events (weather delays, user actions)
- **PDF Export**: Ready-to-present board reports with timeline visualizations

**Key Deliverables**:
1. `NarrativeExplainerService.ts` - AI-powered variance narrative generation
2. `NarrativeReader.tsx` - Chapter-based storytelling UI component
3. PDF export with timeline visualizations
4. Audit log evidence linking (connects variance to specific user actions)
5. Root cause detection (weather, equipment substitutions, scope changes)

---

## üìã Context & Requirements

### Use Case 22: Narrative Variance Explanation

**User Story**:
> As a **CFO** (BEO user),
> I want to **auto-generate executive summaries of budget variances** in narrative form,
> so that I can **present compelling variance explanations at board meetings** without manual report writing.

**Key Features**:

1. **Chapter-Based Storytelling**:
   - **Chapter 1**: The Plan (original budget, baseline)
   - **Chapter 2**: The Event (what happened - weather, delays, scope change)
   - **Chapter 3**: Equipment Impact (which PFA records were affected)
   - **Chapter 4**: The Ripple Effect (cascading impacts on other equipment)
   - **Chapter 5**: The Outcome (total variance, insurance claims, next steps)

2. **Evidence-Backed Narratives**:
   - Links variance to audit log entries
   - Shows WHO made changes (e.g., "John Doe extended 18 crane rentals")
   - Shows WHEN changes occurred (e.g., "Nov 21-25")
   - Shows WHY changes were made (e.g., "Weather delay - concrete curing")

3. **Timeline Visualization**:
   - ASCII timeline showing events in chronological order
   - Variance waterfall: Plan ‚Üí Event ‚Üí Crane Extensions ‚Üí Ripple Effect ‚Üí Forecast
   - Export as interactive SVG for PowerPoint

4. **Key Takeaways Summary**:
   - Bullet-point summary at end of narrative
   - Actionable recommendations
   - Insurance claim status (if applicable)

5. **Reading Progress Indicator**:
   - Sticky progress bar showing chapter position
   - Estimated reading time (e.g., "8 min read")
   - Auto-save reading position (resume where left off)

6. **PDF Export**:
   - Professional formatting for board decks
   - Includes timeline visualization
   - Footer: "Generated by PFA Vanguard AI - [Date]"

---

## üõ†Ô∏è Technical Specifications

### Backend Implementation

**File**: `backend/src/services/ai/NarrativeExplainerService.ts`

**Core Methods**:

```typescript
export class NarrativeExplainerService {
  /**
   * Generate executive-level narrative explanation for budget variance
   *
   * @param organizationId - Project to analyze (e.g., 'HOLNG')
   * @param variance - Total variance amount (e.g., 450000 for $450K)
   * @param variancePercent - Variance percentage (e.g., 12 for +12%)
   *
   * @returns {Object} Chapter-based narrative with evidence and timeline
   */
  async explainVariance(params: {
    organizationId: string;
    variance: number;
    variancePercent: number;
  }): Promise<{
    narrativeId: string; // For tracking
    title: string; // e.g., "The November Weather Delay Story: How HOLNG went $450K over budget"
    chapters: Array<{
      number: number;
      title: string;
      content: string; // Narrative text (2-3 paragraphs)
      evidence?: Array<{
        type: 'audit_log' | 'weather_data' | 'financial_summary';
        summary: string;
        details: any;
      }>;
      financialImpact?: number; // $ amount attributed to this chapter
    }>;
    keyTakeaways: string[]; // Bullet points
    timeline: TimelineEvent[]; // For visualization
    recommendations: string[];
    estimatedReadTime: number; // Minutes
  }>;

  /**
   * Get detailed PFA data and audit logs for an organization
   *
   * Queries:
   * - All PFA records with forecast vs. plan variance
   * - Audit log entries where action = 'updated' and organizationId matches
   * - Groups changes by user, date, and reason field
   */
  private async getVarianceData(organizationId: string): Promise<{
    pfaRecords: PfaRecord[];
    auditLogs: AuditLogEntry[];
    categoryVariances: Record<string, number>; // Variance by category
    userActions: Record<string, number>; // Changes by user
  }>;

  /**
   * Use AI to generate narrative chapters
   *
   * Prompt Engineering:
   * - Persona: "You are a CFO explaining variance to the board"
   * - Tone: Professional, analytical, actionable
   * - Structure: 5 chapters with evidence-backed explanations
   * - Constraints: Each chapter 150-250 words, avoid jargon
   */
  private async generateChapters(
    varianceData: any,
    variance: number,
    variancePercent: number
  ): Promise<Chapter[]>;

  /**
   * Build timeline visualization data
   *
   * Timeline Events:
   * - Original Plan Date (baseline)
   * - Triggering Event (weather, scope change)
   * - Equipment Extensions (PFA changes)
   * - Ripple Effects (cascading impacts)
   * - New Forecast Date
   */
  private buildTimeline(varianceData: any): TimelineEvent[];

  /**
   * Extract key takeaways and recommendations
   *
   * Uses AI to:
   * - Summarize root causes (3-5 bullet points)
   * - Identify actionable recommendations
   * - Flag insurance claim opportunities
   */
  private extractTakeaways(chapters: Chapter[]): {
    keyTakeaways: string[];
    recommendations: string[];
  };
}

interface Chapter {
  number: number;
  title: string;
  content: string;
  evidence?: Evidence[];
  financialImpact?: number;
}

interface Evidence {
  type: 'audit_log' | 'weather_data' | 'financial_summary';
  summary: string; // e.g., "18 PFA records modified by john.doe"
  details: {
    count?: number;
    usernames?: string[];
    commonReasons?: Record<string, number>; // Reason ‚Üí count
    dateRange?: { start: Date; end: Date };
  };
}

interface TimelineEvent {
  date: Date;
  label: string; // e.g., "Weather Event", "Crane Extensions"
  type: 'plan' | 'event' | 'impact' | 'forecast';
  financialImpact?: number;
  description?: string;
}
```

**Database Schema Requirements**:

```prisma
model NarrativeReport {
  id                String   @id @default(cuid())
  narrativeId       String   @unique
  organizationId    String
  title             String
  chapters          Json     // Array of Chapter objects
  keyTakeaways      Json     // Array of strings
  timeline          Json     // Array of TimelineEvent objects
  recommendations   Json     // Array of strings
  estimatedReadTime Int      // Minutes
  generatedAt       DateTime @default(now())
  generatedBy       String   // User ID

  // Reading Progress Tracking
  readingProgress   Json?    // Map<userId, { chapter: number, timestamp: Date }>

  // Relations
  organization      Organization @relation(fields: [organizationId], references: [id])
  user              User         @relation(fields: [generatedBy], references: [id])

  @@index([organizationId, generatedAt])
}
```

**API Endpoints**:

```typescript
// POST /api/beo/narrative/generate
router.post('/narrative/generate', requirePermission('perm_ViewAllOrgs'), async (req, res) => {
  const { organizationId } = req.body;

  // Calculate current variance
  const variance = await calculateVariance(organizationId);

  const narrative = await narrativeExplainerService.explainVariance({
    organizationId,
    variance: variance.amount,
    variancePercent: variance.percent,
  });

  // Save to database
  await prisma.narrativeReport.create({
    data: {
      narrativeId: narrative.narrativeId,
      organizationId,
      title: narrative.title,
      chapters: narrative.chapters,
      keyTakeaways: narrative.keyTakeaways,
      timeline: narrative.timeline,
      recommendations: narrative.recommendations,
      estimatedReadTime: narrative.estimatedReadTime,
      generatedBy: req.user!.id,
    },
  });

  res.json(narrative);
});

// GET /api/beo/narrative/:narrativeId
router.get('/narrative/:narrativeId', requirePermission('perm_ViewAllOrgs'), async (req, res) => {
  const narrative = await prisma.narrativeReport.findUnique({
    where: { narrativeId: req.params.narrativeId },
  });

  if (!narrative) {
    return res.status(404).json({ error: 'Narrative not found' });
  }

  res.json(narrative);
});

// POST /api/beo/narrative/:narrativeId/progress
router.post('/narrative/:narrativeId/progress', async (req, res) => {
  const { chapter } = req.body;

  await prisma.narrativeReport.update({
    where: { narrativeId: req.params.narrativeId },
    data: {
      readingProgress: {
        [req.user!.id]: { chapter, timestamp: new Date() },
      },
    },
  });

  res.json({ success: true });
});

// GET /api/beo/narrative/:narrativeId/export-pdf
router.get('/narrative/:narrativeId/export-pdf', async (req, res) => {
  const narrative = await prisma.narrativeReport.findUnique({
    where: { narrativeId: req.params.narrativeId },
  });

  const pdf = await generateNarrativePDF(narrative);

  res.setHeader('Content-Type', 'application/pdf');
  res.setHeader('Content-Disposition', `attachment; filename="${narrative!.title}.pdf"`);
  res.send(pdf);
});
```

---

### Frontend Implementation

**File**: `components/beo/NarrativeReader.tsx`

**Component Structure**:

```tsx
import { useState, useEffect } from 'react';
import { ChevronLeft, ChevronRight, FileText, Download } from 'lucide-react';
import { apiClient } from '../../services/apiClient';

interface Chapter {
  number: number;
  title: string;
  content: string;
  evidence?: Evidence[];
  financialImpact?: number;
}

interface Evidence {
  type: 'audit_log' | 'weather_data' | 'financial_summary';
  summary: string;
  details: any;
}

interface TimelineEvent {
  date: Date;
  label: string;
  type: 'plan' | 'event' | 'impact' | 'forecast';
  financialImpact?: number;
  description?: string;
}

interface NarrativeReport {
  narrativeId: string;
  title: string;
  chapters: Chapter[];
  keyTakeaways: string[];
  timeline: TimelineEvent[];
  recommendations: string[];
  estimatedReadTime: number;
}

export function NarrativeReader({ organizationId }: { organizationId: string }) {
  const [narrative, setNarrative] = useState<NarrativeReport | null>(null);
  const [currentChapter, setCurrentChapter] = useState(0);
  const [loading, setLoading] = useState(true);
  const [expandedEvidence, setExpandedEvidence] = useState(false);
  const [showTimeline, setShowTimeline] = useState(false);

  useEffect(() => {
    generateNarrative();
  }, [organizationId]);

  // Auto-save reading progress
  useEffect(() => {
    if (narrative) {
      saveReadingProgress();
    }
  }, [currentChapter]);

  const generateNarrative = async () => {
    setLoading(true);
    try {
      const result = await apiClient.generateNarrative({ organizationId });
      setNarrative(result);
    } catch (error) {
      console.error('Failed to generate narrative:', error);
      alert('Failed to generate variance narrative');
    } finally {
      setLoading(false);
    }
  };

  const saveReadingProgress = async () => {
    if (!narrative) return;
    await apiClient.updateNarrativeProgress({
      narrativeId: narrative.narrativeId,
      chapter: currentChapter,
    });
  };

  const nextChapter = () => {
    if (narrative && currentChapter < narrative.chapters.length - 1) {
      setCurrentChapter(currentChapter + 1);
      setExpandedEvidence(false); // Collapse evidence when changing chapters
    }
  };

  const previousChapter = () => {
    if (currentChapter > 0) {
      setCurrentChapter(currentChapter - 1);
      setExpandedEvidence(false);
    }
  };

  const exportPDF = async () => {
    if (!narrative) return;
    const blob = await apiClient.exportNarrativePDF(narrative.narrativeId);
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${narrative.title}.pdf`;
    a.click();
  };

  if (loading) {
    return (
      <div className="flex items-center justify-center h-96">
        <div className="text-center">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto mb-4"></div>
          <p className="text-gray-600">Generating variance narrative...</p>
          <p className="text-sm text-gray-500 mt-2">Analyzing audit logs and financial data</p>
        </div>
      </div>
    );
  }

  if (!narrative) {
    return (
      <div className="text-center p-8">
        <p className="text-gray-600">No narrative available</p>
      </div>
    );
  }

  const chapter = narrative.chapters[currentChapter];
  const progress = ((currentChapter + 1) / narrative.chapters.length) * 100;

  return (
    <div className="narrative-reader max-w-4xl mx-auto p-6">
      {/* Sticky Progress Bar */}
      <div className="sticky top-0 bg-white border-b pb-4 mb-6 z-10">
        <div className="flex items-center justify-between mb-2">
          <h1 className="text-2xl font-bold text-gray-900 flex items-center gap-2">
            üìñ {narrative.title}
          </h1>
          <div className="flex items-center gap-2">
            <span className="text-sm text-gray-600">{narrative.estimatedReadTime} min read</span>
            <button
              onClick={exportPDF}
              className="px-3 py-1 bg-gray-100 text-gray-700 rounded hover:bg-gray-200 transition flex items-center gap-1"
            >
              <Download className="w-4 h-4" />
              Export PDF
            </button>
          </div>
        </div>

        {/* Progress Indicator */}
        <div className="mb-2">
          <div className="w-full bg-gray-200 rounded-full h-2">
            <div
              className="bg-blue-500 h-2 rounded-full transition-all duration-300"
              style={{ width: `${progress}%` }}
            ></div>
          </div>
        </div>

        {/* Chapter Navigation Pills */}
        <div className="flex gap-2 flex-wrap">
          {narrative.chapters.map((ch, i) => (
            <button
              key={i}
              onClick={() => {
                setCurrentChapter(i);
                setExpandedEvidence(false);
              }}
              className={`px-3 py-1 rounded text-sm transition ${
                i === currentChapter
                  ? 'bg-blue-500 text-white'
                  : i < currentChapter
                  ? 'bg-green-100 text-green-700'
                  : 'bg-gray-100 text-gray-600'
              }`}
            >
              {i < currentChapter ? '‚úÖ' : i === currentChapter ? '‚óè' : '‚óã'} Chapter {ch.number}
            </button>
          ))}
        </div>
      </div>

      {/* Chapter Content */}
      <div className="bg-white rounded-lg shadow-md p-8">
        {/* Chapter Header */}
        <div className="border-b pb-4 mb-6">
          <div className="flex items-center gap-4 mb-2">
            <span className="text-4xl font-bold text-blue-500">Chapter {chapter.number}</span>
            <div>
              <h2 className="text-2xl font-bold text-gray-900">{chapter.title}</h2>
              {chapter.financialImpact && (
                <p className="text-red-600 font-semibold mt-1">
                  Financial Impact: ${chapter.financialImpact.toLocaleString()}
                </p>
              )}
            </div>
          </div>
        </div>

        {/* Narrative Content */}
        <div className="prose prose-lg max-w-none mb-6">
          {chapter.content.split('\n\n').map((paragraph, i) => (
            <p key={i} className="text-gray-800 leading-relaxed mb-4">
              {paragraph}
            </p>
          ))}
        </div>

        {/* Evidence Section (Collapsible) */}
        {chapter.evidence && chapter.evidence.length > 0 && (
          <div className="border-t pt-4">
            <button
              onClick={() => setExpandedEvidence(!expandedEvidence)}
              className="flex items-center gap-2 text-blue-600 hover:text-blue-700 font-medium mb-3"
            >
              <FileText className="w-5 h-5" />
              {expandedEvidence ? 'Hide' : 'Show'} Evidence ({chapter.evidence.length} items)
            </button>

            {expandedEvidence && (
              <div className="bg-gray-50 p-4 rounded-lg space-y-3">
                {chapter.evidence.map((ev, i) => (
                  <div key={i} className="bg-white p-3 rounded border">
                    <p className="text-sm font-medium text-gray-700 mb-2">
                      üìÑ {ev.type === 'audit_log' ? 'Audit Log' : ev.type === 'weather_data' ? 'Weather Data' : 'Financial Summary'}:
                    </p>
                    <p className="text-sm text-gray-600">{ev.summary}</p>

                    {/* Detailed Evidence */}
                    {ev.details && (
                      <div className="mt-2 text-xs text-gray-500 space-y-1">
                        {ev.details.count && <p>‚Ä¢ Count: {ev.details.count}</p>}
                        {ev.details.usernames && (
                          <p>‚Ä¢ Users: {ev.details.usernames.join(', ')}</p>
                        )}
                        {ev.details.commonReasons && (
                          <div>
                            <p>‚Ä¢ Common Reasons:</p>
                            <ul className="ml-4">
                              {Object.entries(ev.details.commonReasons).map(([reason, count]) => (
                                <li key={reason}>
                                  "{reason}" ({count} times)
                                </li>
                              ))}
                            </ul>
                          </div>
                        )}
                        {ev.details.dateRange && (
                          <p>
                            ‚Ä¢ Date Range: {new Date(ev.details.dateRange.start).toLocaleDateString()} -{' '}
                            {new Date(ev.details.dateRange.end).toLocaleDateString()}
                          </p>
                        )}
                      </div>
                    )}
                  </div>
                ))}
              </div>
            )}
          </div>
        )}

        {/* Navigation Buttons */}
        <div className="flex justify-between items-center mt-8 pt-6 border-t">
          <button
            onClick={previousChapter}
            disabled={currentChapter === 0}
            className="px-4 py-2 bg-gray-100 text-gray-700 rounded hover:bg-gray-200 transition disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2"
          >
            <ChevronLeft className="w-5 h-5" />
            Previous
          </button>

          {currentChapter === narrative.chapters.length - 1 ? (
            <button
              onClick={() => setShowTimeline(true)}
              className="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600 transition"
            >
              View Key Takeaways ‚Üí
            </button>
          ) : (
            <button
              onClick={nextChapter}
              className="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition flex items-center gap-2"
            >
              Continue Reading
              <ChevronRight className="w-5 h-5" />
            </button>
          )}
        </div>
      </div>

      {/* Key Takeaways (shown at end or via button) */}
      {(showTimeline || currentChapter === narrative.chapters.length - 1) && (
        <div className="bg-white rounded-lg shadow-md p-8 mt-6">
          <h2 className="text-2xl font-bold text-gray-900 mb-4 flex items-center gap-2">
            üéØ Key Takeaways
          </h2>

          <ul className="space-y-2 mb-6">
            {narrative.keyTakeaways.map((takeaway, i) => (
              <li key={i} className="flex items-start gap-2">
                <span className="text-blue-500 font-bold">‚Ä¢</span>
                <span className="text-gray-800">{takeaway}</span>
              </li>
            ))}
          </ul>

          {/* Recommendations */}
          {narrative.recommendations.length > 0 && (
            <div className="bg-blue-50 p-4 rounded-lg mb-6">
              <h3 className="font-semibold text-gray-900 mb-2">üí° Recommended Actions:</h3>
              <ul className="space-y-1">
                {narrative.recommendations.map((rec, i) => (
                  <li key={i} className="text-sm text-gray-700">
                    ‚Ä¢ {rec}
                  </li>
                ))}
              </ul>
            </div>
          )}

          {/* Timeline Visualization */}
          <div className="border-t pt-6">
            <h3 className="font-semibold text-gray-900 mb-4">üìÖ Timeline Visualization</h3>
            <TimelineVisualization events={narrative.timeline} />
          </div>

          {/* Action Buttons */}
          <div className="flex gap-3 mt-6">
            <button
              onClick={exportPDF}
              className="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition flex items-center gap-2"
            >
              <Download className="w-5 h-5" />
              Export as PDF
            </button>
            <button className="px-4 py-2 bg-gray-100 text-gray-700 rounded hover:bg-gray-200 transition">
              üìß Email to Stakeholders
            </button>
          </div>
        </div>
      )}
    </div>
  );
}

// Timeline Visualization Component
function TimelineVisualization({ events }: { events: TimelineEvent[] }) {
  return (
    <div className="bg-gray-50 p-6 rounded-lg overflow-x-auto">
      <div className="flex items-center gap-8 min-w-max">
        {events.map((event, i) => (
          <div key={i} className="relative">
            {/* Timeline Line */}
            {i < events.length - 1 && (
              <div className="absolute top-6 left-full w-8 h-0.5 bg-gray-300"></div>
            )}

            {/* Event Node */}
            <div className="flex flex-col items-center">
              <div
                className={`w-12 h-12 rounded-full flex items-center justify-center text-white font-bold mb-2 ${
                  event.type === 'plan'
                    ? 'bg-blue-500'
                    : event.type === 'event'
                    ? 'bg-red-500'
                    : event.type === 'impact'
                    ? 'bg-orange-500'
                    : 'bg-green-500'
                }`}
              >
                {event.type === 'plan' ? 'üìã' : event.type === 'event' ? '‚ö†Ô∏è' : event.type === 'impact' ? 'üìä' : '‚úÖ'}
              </div>

              <p className="text-sm font-medium text-gray-900 text-center max-w-[120px] mb-1">
                {event.label}
              </p>

              <p className="text-xs text-gray-600 text-center">
                {new Date(event.date).toLocaleDateString()}
              </p>

              {event.financialImpact && (
                <p
                  className={`text-sm font-bold mt-1 ${
                    event.financialImpact > 0 ? 'text-red-600' : 'text-green-600'
                  }`}
                >
                  {event.financialImpact > 0 ? '+' : ''}${event.financialImpact.toLocaleString()}
                </p>
              )}

              {event.description && (
                <p className="text-xs text-gray-500 text-center max-w-[120px] mt-1">
                  {event.description}
                </p>
              )}
            </div>
          </div>
        ))}
      </div>
    </div>
  );
}
```

---

## üß™ Testing Requirements

### Test Suite Location
**File**: `backend/tests/integration/narrativeExplainer.test.ts`

### Test Scenarios

```typescript
describe('Use Case 22: Narrative Variance Explainer', () => {
  let beoUser: User;
  let org: Organization;

  beforeEach(async () => {
    // Create BEO user
    beoUser = await prisma.user.create({
      data: {
        username: 'cfo-narrative-test',
        passwordHash: await bcrypt.hash('test123', 10),
        jobTitle: 'CFO',
        userOrganizations: {
          create: {
            organizationId: 'ALL_ORGS',
            role: 'admin',
            capabilities: ['perm_ViewAllOrgs'],
          },
        },
      },
    });

    // Create organization with variance
    org = await prisma.organization.create({
      data: {
        id: 'HOLNG',
        name: 'Houston LNG Project',
      },
    });

    // Seed PFA records with variance
    await prisma.pfaRecord.createMany({
      data: [
        {
          id: 'pfa-crane-1',
          organizationId: 'HOLNG',
          category: 'Crane - Mobile 200T',
          planCost: 100000,
          forecastCost: 150000, // +$50K
          planStart: new Date('2025-11-01'),
          planEnd: new Date('2025-11-25'),
          forecastStart: new Date('2025-11-01'),
          forecastEnd: new Date('2025-12-10'), // +15 days extension
        },
        // ... 17 more crane records
      ],
    });

    // Seed audit log entries
    await prisma.auditLogEntry.createMany({
      data: [
        {
          userId: 'john.doe',
          organizationId: 'HOLNG',
          action: 'updated',
          entityType: 'pfa',
          entityId: 'pfa-crane-1',
          changes: JSON.stringify({
            field: 'forecastEnd',
            oldValue: '2025-11-25',
            newValue: '2025-12-10',
            reason: 'Weather delay - concrete curing',
          }),
          timestamp: new Date('2025-11-21'),
        },
        // ... 17 more audit entries
      ],
    });
  });

  // Test 1: Chapter Generation
  it('should generate 5-chapter narrative', async () => {
    const response = await request(app)
      .post('/api/beo/narrative/generate')
      .set('Authorization', `Bearer ${generateToken(beoUser)}`)
      .send({ organizationId: 'HOLNG' });

    expect(response.status).toBe(200);
    expect(response.body.chapters.length).toBe(5);
    expect(response.body.chapters[0].title).toContain('Plan');
    expect(response.body.chapters[1].title).toContain('Event');
    expect(response.body.chapters[2].title).toContain('Equipment');
    expect(response.body.chapters[3].title).toContain('Ripple');
    expect(response.body.chapters[4].title).toContain('Outcome');
  });

  // Test 2: Evidence Linking
  it('should link variance to audit log evidence', async () => {
    const response = await request(app)
      .post('/api/beo/narrative/generate')
      .set('Authorization', `Bearer ${generateToken(beoUser)}`)
      .send({ organizationId: 'HOLNG' });

    const chapter3 = response.body.chapters[2]; // Equipment Impact chapter
    expect(chapter3.evidence).toBeTruthy();
    expect(chapter3.evidence[0].type).toBe('audit_log');
    expect(chapter3.evidence[0].summary).toContain('18 PFA records modified');
    expect(chapter3.evidence[0].details.usernames).toContain('john.doe');
    expect(chapter3.evidence[0].details.commonReasons['Weather delay']).toBeGreaterThan(0);
  });

  // Test 3: Timeline Generation
  it('should generate timeline with financial impacts', async () => {
    const response = await request(app)
      .post('/api/beo/narrative/generate')
      .set('Authorization', `Bearer ${generateToken(beoUser)}`)
      .send({ organizationId: 'HOLNG' });

    expect(response.body.timeline.length).toBeGreaterThan(3);
    const eventNode = response.body.timeline.find((e: any) => e.type === 'event');
    expect(eventNode.label).toContain('Weather');
    expect(eventNode.financialImpact).toBeGreaterThan(0);
  });

  // Test 4: Key Takeaways Extraction
  it('should extract key takeaways and recommendations', async () => {
    const response = await request(app)
      .post('/api/beo/narrative/generate')
      .set('Authorization', `Bearer ${generateToken(beoUser)}`)
      .send({ organizationId: 'HOLNG' });

    expect(response.body.keyTakeaways.length).toBeGreaterThan(3);
    expect(response.body.keyTakeaways[0]).toContain('Weather');
    expect(response.body.recommendations.length).toBeGreaterThan(0);
    expect(response.body.recommendations[0]).toContain('claim'); // Insurance claim
  });

  // Test 5: Reading Time Estimation
  it('should estimate reading time based on word count', async () => {
    const response = await request(app)
      .post('/api/beo/narrative/generate')
      .set('Authorization', `Bearer ${generateToken(beoUser)}`)
      .send({ organizationId: 'HOLNG' });

    // Avg reading speed: 200 words/min
    // 5 chapters √ó 200 words = 1000 words ‚Üí ~5 min
    expect(response.body.estimatedReadTime).toBeGreaterThan(3);
    expect(response.body.estimatedReadTime).toBeLessThan(15);
  });

  // Test 6: Reading Progress Tracking
  it('should save and retrieve reading progress', async () => {
    const narrativeRes = await request(app)
      .post('/api/beo/narrative/generate')
      .set('Authorization', `Bearer ${generateToken(beoUser)}`)
      .send({ organizationId: 'HOLNG' });

    const narrativeId = narrativeRes.body.narrativeId;

    // Save progress (user on chapter 3)
    await request(app)
      .post(`/api/beo/narrative/${narrativeId}/progress`)
      .set('Authorization', `Bearer ${generateToken(beoUser)}`)
      .send({ chapter: 2 });

    // Retrieve narrative
    const getRes = await request(app)
      .get(`/api/beo/narrative/${narrativeId}`)
      .set('Authorization', `Bearer ${generateToken(beoUser)}`);

    expect(getRes.body.readingProgress[beoUser.id].chapter).toBe(2);
  });

  // Test 7: PDF Export
  it('should export narrative as PDF', async () => {
    const narrativeRes = await request(app)
      .post('/api/beo/narrative/generate')
      .set('Authorization', `Bearer ${generateToken(beoUser)}`)
      .send({ organizationId: 'HOLNG' });

    const pdfRes = await request(app)
      .get(`/api/beo/narrative/${narrativeRes.body.narrativeId}/export-pdf`)
      .set('Authorization', `Bearer ${generateToken(beoUser)}`);

    expect(pdfRes.status).toBe(200);
    expect(pdfRes.headers['content-type']).toBe('application/pdf');
    expect(pdfRes.body.length).toBeGreaterThan(0); // PDF has content
  });
});
```

---

## üîí Security Considerations

### Authorization
- Only BEO users with `perm_ViewAllOrgs` can generate narratives
- Narratives can only be generated for organizations user has access to
- Reading progress is user-scoped (can't see others' progress)

### Data Privacy
- Audit log usernames are shown (transparency requirement)
- If user has `maskFinancials: true`, obfuscate costs in narrative

### AI Prompt Injection Prevention
- Do NOT allow user-provided narrative templates
- Sanitize organization names before passing to AI
- Use parameterized prompts

---

## üìä Performance Optimization

### Latency Budget: <10 Seconds (Narrative Generation)

**Breakdown**:
1. **Database Queries** (Target: 2s):
   - Query PFA records: 1s
   - Query audit logs: 500ms
   - Aggregate variances: 500ms

2. **AI Processing** (Target: 6s):
   - Generate 5 chapters: 5s
   - Extract takeaways: 1s

3. **Timeline Building** (Target: 500ms):
   - Sort events chronologically
   - Calculate financial impacts

4. **Save to Database** (Target: 500ms):
   - Insert narrative report

### Caching Strategy

```typescript
// Cache generated narratives for 1 hour
const cacheKey = `narrative:${organizationId}:${timestamp}`;
const cached = await redis.get(cacheKey);
if (cached) return JSON.parse(cached);

const narrative = await generateNarrative(organizationId);
await redis.setex(cacheKey, 3600, JSON.stringify(narrative));
```

---

## üöÄ Implementation Checklist

### Backend Tasks

- [ ] **Create `NarrativeExplainerService.ts`**
- [ ] **Implement `explainVariance()` method**
- [ ] **Implement `generateChapters()` with AI**
- [ ] **Implement `buildTimeline()` for visualization**
- [ ] **Implement `extractTakeaways()` summarization**
- [ ] **Add `NarrativeReport` model to Prisma schema**
- [ ] **Create API routes** (`/narrative/generate`, `/narrative/:id`, `/export-pdf`)
- [ ] **Implement PDF generation** (use `pdfkit` or `puppeteer`)

### Frontend Tasks

- [ ] **Create `NarrativeReader.tsx` component**
- [ ] **Implement chapter navigation**
- [ ] **Implement reading progress tracking**
- [ ] **Create `TimelineVisualization` component**
- [ ] **Add PDF export button**
- [ ] **Add responsive design** (mobile chapter pills)

### Testing Tasks

- [ ] **Test 1**: Chapter generation (5 chapters)
- [ ] **Test 2**: Evidence linking (audit logs)
- [ ] **Test 3**: Timeline generation
- [ ] **Test 4**: Takeaways extraction
- [ ] **Test 5**: Reading time estimation
- [ ] **Test 6**: Progress tracking
- [ ] **Test 7**: PDF export

---

## üéØ Acceptance Criteria

‚úÖ **AI generates 5-chapter narrative from variance data**
‚úÖ **Each chapter includes evidence from audit logs**
‚úÖ **Timeline visualization shows events chronologically**
‚úÖ **Key takeaways and recommendations are actionable**
‚úÖ **Reading progress is saved and restored**
‚úÖ **PDF export includes narrative + timeline**
‚úÖ **Narrative generation completes in <10 seconds**
‚úÖ **Only BEO users can access narratives**

---

**End of Prompt Bundle: Task 8.2 - Narrative Variance Generator**

**Status**: Ready for Execution by `ai-systems-architect`
**Estimated Completion**: 0.5 days
**Next Task**: 8.3 - Asset Arbitrage Detector
